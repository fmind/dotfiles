---

- hosts: localhost
  connection: local
  become: yes
  vars_files:
    - variables/datomic
    - variables/host

  tasks:

  - name: Ensure Datomic user exists; {{host_service_user}}
    user: name="{{host_service_user}}" state="present"

  - name: Ensure Datomic group exists; {{host_service_group}}
    group: name="{{host_service_group}}" state="present"

  - name: Ensures Var directory exists; {{host_var_dir}}
    file: path="{{host_var_dir}}" state=directory owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_dir_mode}}"

  - name: Ensures Data directory exists; {{host_data_dir}}
    file: path="{{host_data_dir}}" state=directory owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_dir_mode}}"

  - name: Ensures Log directory exists; {{host_log_dir}}
    file: path="{{host_log_dir}}" state="directory" owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_dir_mode}}"

  - name: Register Datomic version currently installed
    command: cat "{{host_install_version_file}}"
    register: version_result
    ignore_errors: True

  - name: Install Datomic free to; {{host_install_version_dir}}
    unarchive: src="{{datomic_install_link}}" dest="{{host_opt_dir}}" copy="no" owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_dir_mode}}"
    when: datomic_install_version != version_result.stdout

  - name: Link {{host_install_version_dir}} to; {{host_install_current_dir}}
    file: src="{{host_install_version_dir}}" dest="{{host_install_current_dir}}" state="link" force="yes"

  - name: Deploy configuration from template to {{host_config_file}}
    template: src="configurations/datomic.properties" dest="{{host_config_file}}" owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_file_mode}}"

  - name: Deploy service from template to {{host_service_file}}
    template: src="configurations/datomic.service" dest="{{host_service_file}}" owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_file_mode}}"

  - name: Deploy logback to {{host_log_file}}
    copy: src="configurations/logback.xml" dest="{{host_log_file}}" owner="{{host_service_user}}" group="{{host_service_group}}" mode="{{host_file_mode}}"
